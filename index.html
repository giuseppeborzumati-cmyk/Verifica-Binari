
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Verifiche Rete e Conversione</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1e40af',
                        'secondary-orange': '#ea580c',
                        'accent-pink': '#e91e63',
                    }
                }
            }
        }
    </script>
    <style>
        /* Stili per la pagina HTML */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        .container-main { max-width: 900px; }
        .btn-primary { transition: all 0.2s; }
        .btn-primary:hover { @apply bg-primary-blue/90 transform scale-[1.02]; }

        /* Stili per il PDF A4 Nascosto (CRITICO per il layout) */
        .a4-container {
            width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height */
            margin: 0 auto;
            padding: 15mm;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            color: #333;
            font-family: 'Inter', sans-serif;
            page-break-after: always;
        }

        .page-break {
            height: 10px;
            margin: 15mm 0;
            page-break-after: always;
            visibility: hidden;
            display: block; /* Important for PDF generation */
        }

        .pdf-header {
            border-bottom: 3px solid #e91e63;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .pdf-footer {
            margin-top: 30px;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
            font-size: 0.75rem;
            color: #555;
        }

        .punteggio-grid {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        .punteggio-grid th, .punteggio-grid td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .punteggio-grid th {
            background-color: #e6e9f2;
            color: #1e40af;
        }
        .table-conversion th, .table-conversion td {
            border: 1px solid #9ca3af;
            padding: 6px 12px;
            text-align: center;
            font-size: 0.85rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="container-main mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-primary-blue mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-secondary-orange" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9h.01" />
            </svg>
            Generatore Verifiche Reti e Basi Numeriche
        </h1>
        <p class="text-gray-600 mb-6 border-b pb-4">Crea set di verifiche uniche su Subnetting e Conversioni Numeriche (Basi 2, 8, 10, 16, Romani). Difficoltà scalare e validazione Teorica/Pratica.</p>

        <div class="space-y-4">
            <label for="studentCount" class="block text-lg font-medium text-gray-700">Numero di Alunni:</label>
            <input type="number" id="studentCount" value="5" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary-orange focus:border-secondary-orange transition duration-150" placeholder="Inserisci il numero di studenti (es. 10)">
        </div>

        <button onclick="generateAndDownloadZip()" id="generateBtn" class="btn-primary w-full mt-6 px-6 py-3 bg-primary-blue text-white font-semibold rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-secondary-orange focus:ring-opacity-50 flex items-center justify-center">
            <svg id="downloadIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            <svg id="loadingIcon" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Genera & Scarica ZIP Verifiche
        </button>

        <div id="messageBox" class="mt-6 p-4 rounded-lg text-sm hidden"></div>

    </div>

    <!-- Contenitore Nascosto per la Generazione PDF -->
    <div id="pdfContainer" class="hidden"></div>

    <script type="text/javascript">
        // Le costanti globali (necessarie per l'aderenza al protocollo)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- LOGICA DI GENERAZIONE DEI PROBLEMI (OMESSA PER BREVITÀ, RIMANE INVARIATA) ---

        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        // Funzioni di utilità per il Subnetting
        function ipToDecimal(ip) {
            return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0);
        }
        function decimalToIp(decimal) {
            return [
                (decimal >>> 24) & 0xFF,
                (decimal >>> 16) & 0xFF,
                (decimal >>> 8) & 0xFF,
                decimal & 0xFF
            ].join('.');
        }
        function calculateSubnetDetails(ip, cidr) {
            const prefix = cidr;
            const maskDec = (0xFFFFFFFF << (32 - prefix)) >>> 0;
            const maskIp = decimalToIp(maskDec);
            const ipDec = ipToDecimal(ip);
            const netIdDec = ipDec & maskDec;
            const netIdIp = decimalToIp(netIdDec);
            const broadcastDec = netIdDec | (~maskDec >>> 0);
            const broadcastIp = decimalToIp(broadcastDec);
            const firstHost = decimalToIp(netIdDec + 1);
            const lastHost = decimalToIp(broadcastDec - 1);
            const maxHosts = (1 << (32 - prefix)) - 2;

            return { maskIp, netIdIp, broadcastIp, firstHost, lastHost, maxHosts };
        }

        // --- Generazione di Tracce Uniche ---

        function generateSubnettingProblem(level, studentId) {
            let ip, cidr, requiredHosts;
            let description = "";
            let solution = "";
            let questions = [];

            if (level <= 3) { // Facile - Calcolo diretto (Classe C)
                ip = `192.168.${getRandomInt(10, 20)}.${getRandomInt(10, 250)}`;
                cidr = getRandomInt(25, 29);
                const details = calculateSubnetDetails(ip, cidr);
                description = `**Subnetting Base:** Analizza l'indirizzo IP: **${ip}/${cidr}**.
                Calcola: Network ID (Indirizzo di Rete), Broadcast ID, Maschera di Sottorete, Primo Host Valido e Ultimo Host Valido.
                `;
                solution = `IP/CIDR: ${ip}/${cidr}\nMaschera: ${details.maskIp}\nNetwork ID: ${details.netIdIp}\nBroadcast ID: ${details.broadcastIp}\nPrimo Host: ${details.firstHost}\nUltimo Host: ${details.lastHost}`;
                questions = [
                    `Definisci in termini semplici il ruolo del Broadcast ID e perché l'indirizzo ${details.broadcastIp} non può essere assegnato a un host.`,
                    `Spiega il significato di un prefisso **/32** o **/31** nel contesto IPv4, e a cosa servono.`,
                ];
            } else if (level <= 6) { // Medio - Calcolo Hosts/Subnetting (Classe B)
                ip = `172.${getRandomInt(16, 31)}.${getRandomInt(0, 255)}.${getRandomInt(0, 255)}`;
                requiredHosts = getRandomInt(50, 200);
                cidr = getRandomInt(18, 24);
                
                // Calcola il CIDR necessario per gli host richiesti
                let bitsHost = Math.ceil(Math.log2(requiredHosts + 2));
                let newCidr = 32 - bitsHost;
                
                const originalDetails = calculateSubnetDetails(ip, cidr);
                const newDetails = calculateSubnetDetails(ip, newCidr);

                description = `**Subnetting e Requisiti:** L'indirizzo di rete base è **${originalDetails.netIdIp}/${cidr}**. Devi segmentare questa rete per ospitare almeno **${requiredHosts} host** per ogni sottorete.
                **Domanda Pratica:**
                1. Qual è il prefisso CIDR minimo **/X** necessario per soddisfare il requisito?
                2. Qual è la nuova Maschera di Sottorete corrispondente?
                3. Qual è l'indirizzo di Broadcast della **seconda** sottorete disponibile (la prima subnet utile)?
                `;
                
                // Calcolo Broadcast della Seconda Subnet
                const blockHosts = Math.pow(2, bitsHost);
                const secondNetDec = ipToDecimal(originalDetails.netIdIp) + blockHosts;
                const secondNetIp = decimalToIp(secondNetDec);
                const secondBroadcast = calculateSubnetDetails(secondNetIp, newCidr).broadcastIp;

                solution = `Host richiesti: ${requiredHosts}. Bit necessari: ${bitsHost}. Nuovo CIDR: /${newCidr}. Maschera: ${newDetails.maskIp}. Broadcast 2ª Subnet: ${secondBroadcast}`;
                questions = [
                    `Perché, nel calcolo di ${requiredHosts} host, dobbiamo considerare un numero di indirizzi disponibili pari a $2^n - 2$? Spiega la ragione dei due indirizzi sottratti.`,
                    `Spiega la differenza tra VLSM (Variable Length Subnet Mask) e la subnetting tradizionale, e come VLSM aiuta a conservare gli indirizzi IP.`,
                ];
            } else { // Complesso - Subnetting Classless e Calcolo Decimale Binario
                ip = `10.${getRandomInt(1, 254)}.${getRandomInt(1, 254)}.${getRandomInt(1, 254)}`;
                cidr = getRandomInt(10, 15);
                
                const details = calculateSubnetDetails(ip, cidr);
                const maskDec = ipToDecimal(details.maskIp);
                
                description = `**Subnetting Classless e Analisi Bitwise (AI Trap):** Analizza l'indirizzo **${ip}/${cidr}**.
                **Domanda Pratica (A):** Calcola il Primo Indirizzo Host Valido e l'Ultimo Indirizzo Host Valido.
                **Domanda Pratica (B):** Scrivi il valore **decimale** dell'Indirizzo di Rete (${details.netIdIp}) e della Maschera di Sottorete (${details.maskIp}) come un unico numero a 32 bit. Spiega come l'operazione AND bitwise tra questi due numeri a 32 bit porta al Network ID.
                `;
                
                const ipDecFull = ipToDecimal(ip);
                const netDecFull = ipToDecimal(details.netIdIp);

                solution = `Primo Host: ${details.firstHost}\nUltimo Host: ${details.lastHost}\nMaschera Decimale (32 bit): ${maskDec}\nNetwork ID Decimale (32 bit): ${netDecFull}`;
                questions = [
                    `Perché nel contesto di un calcolo di Network ID, l'uso di un numero decimale a 32 bit per rappresentare l'IP e la Maschera è più preciso concettualmente che lavorare ottetto per ottetto?`,
                    `Definisci il concetto di "Classe di Rete" (A, B, C) e spiega perché, con il CIDR (${cidr}), tale classificazione è diventata obsoleta.`,
                ];
            }

            return { description, solution, questions };
        }

        function generateConversionProblem(level, studentId) {
            let num, base, description, solution, questions = [];
            const bases = [2, 8, 10, 16];

            if (level <= 2) { // Facile - Conversione semplice tra basi standard
                base = bases[getRandomInt(0, 3)];
                let targetBase = base;
                while (targetBase === base) { targetBase = bases[getRandomInt(0, 3)]; }
                
                let numDec;
                if (base === 10) numDec = getRandomInt(100, 500);
                else numDec = getRandomInt(10, 50).toString(base);
                
                description = `**Conversione Diretta:** Converti il numero: **${numDec}** (base ${base}) in base ${targetBase}.
                `;
                solution = `Risultato in Base ${targetBase}: ${parseInt(numDec, base).toString(targetBase)}`;
                questions = [
                    `Qual è il set di simboli (cifre) valido per la Base ${base} e per la Base ${targetBase}?`,
                    `Perché in informatica la Base 2 e la Base 16 sono spesso utilizzate insieme?`
                ];
            } else if (level <= 5) { // Medio - Notazione polinomiale e frazioni
                base = bases[getRandomInt(0, 3)];
                let numInt = getRandomInt(10, 100);
                let numDec = numInt.toString(base);
                
                description = `**Notazione Polinomiale:** Converti il numero in base ${base}: **${numDec}** in base 10, utilizzando esplicitamente e mostrando il procedimento della *Notazione Polinomiale*.
                `;
                solution = `Base 10: ${parseInt(numDec, base)}`;
                questions = [
                    `Spiega il concetto di "peso" della cifra nella Notazione Polinomiale.`,
                    `Se il numero fosse stato in Base 8, come sarebbe cambiato il coefficiente di $8^1$?`
                ];

            } else if (level <= 8) { // Difficile - Frazioni binarie e notazione romana
                const challengeType = getRandomInt(1, 2);

                if (challengeType === 1) {
                    // Frazione Binaria (lunga e teorica)
                    const integerPart = getRandomInt(1, 15);
                    const fractionalPartDec = Math.random() / 2 + 0.1; // 0.1 a 0.6 per evitare overflow
                    const decimal = (integerPart + fractionalPartDec).toFixed(4);

                    description = `**Conversione Binaria con Virgola:** Converti il numero in base 10 con virgola: **${decimal}** in base 2. Interrompi la conversione dopo 8 cifre binarie dopo la virgola.
                    **Domanda Teorica:** Dimostra il metodo delle moltiplicazioni ripetute per la parte frazionaria.
                    `;
                    const intBin = integerPart.toString(2);
                    let fracDec = parseFloat(decimal) - integerPart;
                    let fracBin = '';
                    let limit = 8;
                    while (fracDec > 0 && limit-- > 0) {
                        fracDec *= 2;
                        fracBin += Math.floor(fracDec);
                        fracDec -= Math.floor(fracDec);
                    }
                    solution = `Base 2: ${intBin}.${fracBin}`;
                    questions = [
                        `Spiega cosa significa che una frazione binaria è "periodica" e come si manifesta questo nel metodo delle moltiplicazioni.`,
                        `Se l'obiettivo fosse convertire un numero in base 10 in base 8 con virgola, quale operazione ripetuta useresti al posto della moltiplicazione per 2?`
                    ];
                } else {
                    // Numeri Romani Complesso (con teoria)
                    num = getRandomInt(1500, 3000);
                    const romanMap = { M: 1000, CM: 900, D: 500, CD: 400, C: 100, XC: 90, L: 50, XL: 40, X: 10, IX: 9, V: 5, IV: 4, I: 1 };
                    const keys = Object.keys(romanMap);
                    let result = '';
                    let tempNum = num;
                    for (let i = 0; i < keys.length; i++) {
                        while (tempNum >= romanMap[keys[i]]) {
                            result += keys[i];
                            tempNum -= romanMap[keys[i]];
                        }
                    }

                    description = `**Numeri Romani Complesso:** Converti il numero decimale **${num}** nella sua rappresentazione in Numeri Romani.
                    **Domanda Teorica:** Scrivi le due regole fondamentali che governano la notazione *sottrattiva* (es. CM, XL) nei Numeri Romani, e spiega perché *IM* non è una combinazione valida.
                    `;
                    solution = `Numero Romano: ${result}`;
                    questions = [
                        `Spiega la regola di base che impedisce la ripetizione di simboli come V, L e D più di una volta consecutiva.`,
                        `Perché il sistema dei Numeri Romani è considerato un sistema additivo/sottrattivo non posizionale, a differenza della base 10?`
                    ];
                }
            } else { // Molto Complesso - Conversione mix + teoria estesa (AI Trap)
                // AI Trap: base non standard/analisi teorica di una rappresentazione
                const baseTarget = getRandomInt(2, 9);
                const numSource = (getRandomInt(10, 20) * baseTarget + getRandomInt(1, baseTarget - 1)).toString(baseTarget);
                
                description = `**Analisi di Base Sconosciuta e Conversione:** Ti viene fornito un numero: **${numSource}**. Sei sicuro che la sua base sia **Base ${baseTarget}**.
                **Domanda Pratica:** Converti **${numSource}** in base 10 e poi in Base 16.
                **Domanda Teorica:** Ipotizza che lo stesso numero (**${numSource}**) fosse stato in Base 5 invece che Base ${baseTarget}. Quale sarebbe stato il suo valore in Base 10? Indica quale parte della Notazione Polinomiale cambierebbe e perché il numero, se letto in Base 5, sarebbe potenzialmente ambiguo.
                `;
                const valBase10 = parseInt(numSource, baseTarget);
                const valBase16 = valBase10.toString(16).toUpperCase();
                
                solution = `Base 10 (con Base ${baseTarget}): ${valBase10}\nBase 16: ${valBase16}`;
                questions = [
                    `Per convertire ${numSource} dalla Base ${baseTarget} alla Base 10, devi moltiplicare le cifre per potenze di ${baseTarget}. Quale operazione *fondamentale* della Notazione Polinomiale cambierebbe se la base fosse 5?`,
                    `Spiega perché, se la Base fosse 5, il numero ${numSource} non sarebbe ambiguo, ma se fosse Base 4 sì (e cosa accadrebbe in quel caso).`
                ];
            }
            
            return { description, solution, questions };
        }


        function generateExercise(index, studentId) {
            const level = index + 1;
            let problemData;
            const points = [8, 8, 10, 10, 10, 12, 12, 15, 15, 10]; // Totale 100 punti
            const totalPoints = points[index];
            
            // Alternanza dei problemi e aumento della complessità
            if (level % 2 !== 0) { // Dispari: Conversione
                problemData = generateConversionProblem(level, studentId);
            } else { // Pari: Subnetting
                problemData = generateSubnettingProblem(level, studentId);
            }

            // Punteggi divisi: Teoria (T) e Pratica (P)
            // Tende a privilegiare la pratica nei primi esercizi e la teoria nei successivi
            let theoreticalPoints, practicalPoints;
            if (level <= 4) {
                practicalPoints = Math.ceil(totalPoints * 0.6); // 60% pratica
                theoreticalPoints = totalPoints - practicalPoints;
            } else {
                theoreticalPoints = Math.ceil(totalPoints * 0.5); // 50% teoria (più teoria complessa)
                practicalPoints = totalPoints - theoreticalPoints;
            }

            return {
                title: `Esercizio ${level} (Max ${totalPoints} Punti)`,
                description: problemData.description,
                solution: problemData.solution,
                questions: problemData.questions,
                totalPoints,
                theoreticalPoints,
                practicalPoints
            };
        }

        // --- TEMPLATE GENERATION (HTML to PDF) ---

        // FUNZIONE AGGIORNATA PER LA STRUTTURA HTML PULITA
        function generateStudentHtml(studentNumber, exercises) {
            const date = new Date().toLocaleDateString('it-IT');
            const totalPoints = exercises.reduce((sum, ex) => sum + ex.totalPoints, 0);
            let fullHtml = '';

            // --- PAGINA 1: Tracce (Prima Pagina) ---
            fullHtml += `
                <div class="a4-container">
                    <div class="pdf-header text-primary-blue font-bold text-lg text-center">
                        Verifica prodotta da Prof. Giuseppe Borzumati - Verifica di Rete e Basi Numeriche
                    </div>

                    <div class="flex justify-between text-sm mb-6 bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div class="w-1/2">
                            <p class="font-semibold text-secondary-orange">Nome e Cognome:</p>
                            <div class="border-b border-gray-300 mb-2 mt-1">Verifica Studente ${studentNumber}</div>
                        </div>
                        <div class="w-1/2 ml-4">
                            <p class="font-semibold text-secondary-orange">Classe/Indirizzo:</p>
                            <div class="border-b border-gray-300 mb-2 mt-1"></div>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm mb-10 bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div class="w-1/2">
                            <p class="font-semibold text-secondary-orange">Data:</p>
                            <div class="border-b border-gray-300 mb-2 mt-1">${date}</div>
                        </div>
                        <div class="w-1/2 ml-4">
                            <p class="font-semibold text-primary-blue">ID Prova Unica:</p>
                            <div class="mb-2 mt-1">#${appId}-${studentNumber}</div>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold text-primary-blue mb-4">Tracce Esercizi (Da 1 a 10)</h2>
            `;
            
            // Inserimento Tracce Esercizi (2 per pagina per evitare sovrapposizioni critiche)
            exercises.forEach((ex, index) => {
                const isEndOfPage = (index + 1) % 2 === 0 && index < 9;
                
                fullHtml += `
                    <div class="mb-8 p-4 border border-gray-300 rounded-lg shadow-sm bg-white break-inside-avoid-page">
                        <h3 class="text-lg font-semibold text-accent-pink mb-2">${ex.title}</h3>
                        <div class="text-gray-800 leading-relaxed">${ex.description.replace(/\n/g, '<br>').replace(/\*\*/g, '<b>').replace(/<\/b> /g, '</b>&nbsp;')}</div>
                        <div class="mt-4">
                            <p class="font-medium text-primary-blue">Risposta/Output Finale:</p>
                            <div class="border border-gray-400 h-16 w-full mt-1 rounded-sm bg-gray-50"></div>
                        </div>
                        <p class="mt-3 text-sm text-gray-600">Punteggio Max: ${ex.totalPoints} punti</p>
                    </div>
                `;

                if (isEndOfPage) {
                    // Chiudi la pagina attuale e apri la successiva per la Spiegazione
                    fullHtml += `
                        <p class="pdf-footer mt-12">Verifica di Rete e Basi Numeriche - ID Prova Unica: #${appId}-${studentNumber}</p>
                    </div>
                    <div class="page-break"></div>
                    <div class="a4-container">
                        <div class="pdf-header text-primary-blue font-bold text-lg text-center">
                            Spiegazione Dettagliata (Obbligatoria)
                        </div>
                        <p class="text-sm italic text-secondary-orange mb-6">Attenzione: Per ottenere il punteggio massimo, ogni risposta deve essere accompagnata da una spiegazione chiara e personale.</p>
                    `;
                }
            });

            // --- PAGINE INTERMEDIE: Spiegazione Dettagliata ---
            fullHtml += `
                <div class="page-break"></div>
                <div class="a4-container">
                    <div class="pdf-header text-primary-blue font-bold text-lg text-center">
                        Spiegazione Dettagliata (Obbligatoria)
                    </div>

                    <div class="text-xs text-gray-500 mb-8">
                        <p>Nome e Cognome: Verifica Studente ${studentNumber}</p>
                        <p>Classe/Indirizzo: ............................</p>
                        <p>Data: ${date}</p>
                    </div>

                    <h2 class="text-xl font-bold text-primary-blue mb-4">Spiegazione Dettagliata (Obbligatoria)</h2>
            `;
            
            exercises.forEach((ex, index) => {
                // Griglia di Attribuzione Punteggio
                const max = ex.totalPoints;
                const teo = ex.theoreticalPoints;
                const pra = ex.practicalPoints;

                fullHtml += `
                    <div class="mb-10 p-4 border-2 border-primary-blue/30 rounded-xl bg-blue-50 break-inside-avoid-page">
                        <h4 class="text-lg font-bold text-primary-blue mb-3">Spiegazione per l'Esercizio ${index + 1} (Max ${max} Punti)</h4>

                        <table class="punteggio-grid">
                            <thead>
                                <tr>
                                    <th>Indicatore</th>
                                    <th>Punti Max</th>
                                    <th>Valutazione</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Svolgimento/Risultato Pratico (Max ${pra} Punti)</td>
                                    <td>${pra}</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>Spiegazione/Teoria (Max ${teo} Punti)</td>
                                    <td>${teo}</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Totale</td>
                                    <td class="font-bold">${max}</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-xs text-gray-500 italic">Punteggio attribuito solo se la risposta è chiara (100%) o semi-chiara (50%).</td>
                                </tr>
                            </tbody>
                        </table>

                        <p class="font-semibold text-secondary-orange mt-4 mb-2">Domande Specifica per la Spiegazione (Risposta personale):</p>
                        <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                            ${ex.questions.map(q => `<li class="ml-2">${q}</li>`).join('')}
                        </ul>
                        <p class="mt-4 font-semibold text-gray-800">Spazio per la tua Spiegazione (Usa le linee sottostanti):</p>
                        <div class="mt-2 space-y-2">
                            ${Array(8).fill().map(() => `<div class="border-b border-gray-300 h-4"></div>`).join('')}
                        </div>
                    </div>
                `;
            });
            
            // Chiudi l'ultima Pagina di Spiegazione
            fullHtml += `
                    <p class="pdf-footer mt-12">Verifica di Rete e Basi Numeriche prodotta dal Professore Giuseppe Borzumati - ID Prova Unica: #${appId}-${studentNumber}</p>
                </div>
            `;


            // --- ULTIMA PAGINA: Griglia Conversione Finale ---
            fullHtml += `
                <div class="page-break"></div>
                <div class="a4-container">
                    <div class="pdf-header text-primary-blue font-bold text-lg text-center">
                        Griglia di Conversione (Voto Base 10)
                    </div>

                    <h2 class="text-xl font-bold text-primary-blue mb-4">Griglia di Conversione Finale</h2>
                    <p class="text-gray-600 mb-4">Punteggio Totale Ottenuto (Max ${totalPoints}) convertito in Voto Base 10.</p>

                    <table class="table-conversion w-full">
                        <thead>
                            <tr class="bg-primary-blue text-white">
                                <th colspan="2">Punteggio (P) / Voto Base 10</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-red-100">
                                <td>Da 0 &le; P &lt; 35</td> <td>3</td>
                                <td>Da 66 &le; P &lt; 75</td> <td>7</td>
                            </tr>
                            <tr class="bg-orange-100">
                                <td>Da 35 &le; P &lt; 45</td> <td>4</td>
                                <td>Da 75 &le; P &lt; 85</td> <td>8</td>
                            </tr>
                            <tr class="bg-yellow-100">
                                <td>Da 45 &le; P &lt; 55</td> <td>5</td>
                                <td>Da 85 &le; P &lt; 95</td> <td>9</td>
                            </tr>
                            <tr class="bg-green-100">
                                <td>Da 55 &le; P &lt; 66</td> <td>6</td>
                                <td>Da 95 &le; P &le; ${totalPoints}</td> <td>10</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <p class="pdf-footer mt-12">Verifica di Rete e Basi Numeriche prodotta dal Professore Giuseppe Borzumati - ID Prova Unica: #${appId}-${studentNumber}</p>
                </div>
            `;
            return fullHtml;
        }

        // FUNZIONE AGGIORNATA PER LA STRUTTURA HTML PULITA (SOLUZIONI DOCENTE)
        function generateProfessorHtml(exercises) {
            let solutionsHtml = ''; // Start empty

            // --- Pagina 1: Introduzione e Inizio Soluzioni ---
            solutionsHtml += `
                <div class="a4-container">
                    <div class="pdf-header text-primary-blue font-bold text-lg text-center">
                        SOLUZIONI DOCENTE - Verifica prodotta da Prof. Giuseppe Borzumati
                    </div>

                    <h2 class="text-xl font-bold text-primary-blue mb-6">Soluzioni Dettagliate per la Verifica di Rete e Basi Numeriche</h2>
                    <p class="text-sm italic text-secondary-orange mb-8">Queste soluzioni si applicano all'intero set di verifiche generate (la traccia varia solo per i parametri numerici, la logica e la spiegazione restano le stesse).</p>
            `;
            
            // Loop for exercises (3 per page)
            exercises.forEach((ex, index) => {
                solutionsHtml += `
                    <div class="mb-10 p-5 border-2 border-accent-pink/50 rounded-xl bg-pink-50 break-inside-avoid-page">
                        <h3 class="text-xl font-extrabold text-accent-pink mb-3">Esercizio ${index + 1} - Soluzione (Max ${ex.totalPoints} Punti)</h3>

                        <h4 class="font-bold text-primary-blue mt-4">Traccia Generale (Esempio):</h4>
                        <p class="text-sm italic text-gray-700 mb-3 leading-relaxed">${ex.description.replace(/\n/g, '<br>').replace(/\*\*/g, '<b>').replace(/<\/b> /g, '</b>&nbsp;')}</p>

                        <h4 class="font-bold text-primary-blue mt-4">Soluzione/Risultato Pratico:</h4>
                        <pre class="bg-gray-800 text-white p-3 rounded-md text-sm">${ex.solution}</pre>

                        <h4 class="font-bold text-primary-blue mt-4">Spiegazione Dettagliata (Criteri di Valutazione - Max ${ex.theoreticalPoints} Punti):</h4>
                        <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                            ${ex.questions.map(q => `<li class="ml-2">**Risposta attesa per:** *${q}*: [Punti chiave teorici da verificare].</li>`).join('')}
                        </ul>
                        
                        <h4 class="font-bold text-primary-blue mt-4">Griglia di Attribuzione del Punteggio:</h4>
                        <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                            <li>**Punti Pratici (Max ${ex.practicalPoints}):** Attribuiti per la correttezza del risultato numerico (Subnet ID, Conversione finale).</li>
                            <li>**Punti Teorici (Max ${ex.theoreticalPoints}):** Attribuiti per la chiarezza e la precisione della spiegazione fornita (risposta alle domande teoriche e metodologia).</li>
                            <li>**Giudizio:** 100% dei punti se risposta chiara, 50% dei punti se risposta semi-chiara/parziale, 0 punti altrimenti.</li>
                        </ul>
                    </div>
                `;
                
                // Logica di paginazione: chiudi il contenitore corrente, aggiungi interruzione, apri un nuovo contenitore
                // Interruzione di pagina dopo ogni 3 esercizi, ma non dopo l'ultimo (index 9)
                if ((index + 1) % 3 === 0 && index < 9) {
                    solutionsHtml += `
                        <p class="pdf-footer mt-12">Documento Soluzioni prodotto dal Professore Giuseppe Borzumati - Pagina Soluzioni ${Math.ceil((index + 1) / 3)}</p>
                    </div> 
                    <div class="page-break"></div>
                    <div class="a4-container">
                        <div class="pdf-header text-primary-blue font-bold text-lg text-center">SOLUZIONI DOCENTE - Verifica prodotta da Prof. Giuseppe Borzumati</div>
                    `;
                }
            });

            // Chiudi il contenitore finale a4-container
            solutionsHtml += `
                    <p class="pdf-footer mt-12">Documento Soluzioni prodotto dal Professore Giuseppe Borzumati - Riferimento Prova: #${appId}</p>
                </div>
            `;
            return solutionsHtml;
        }

        // --- FUNZIONE PRINCIPALE DI GENERAZIONE PDF E ZIP ---

        async function generateAndDownloadZip() {
            const studentCountInput = document.getElementById('studentCount');
            const studentCount = parseInt(studentCountInput.value, 10);
            const messageBox = document.getElementById('messageBox');
            const generateBtn = document.getElementById('generateBtn');
            const downloadIcon = document.getElementById('downloadIcon');
            const loadingIcon = document.getElementById('loadingIcon');

            if (isNaN(studentCount) || studentCount < 1) {
                messageBox.className = 'mt-6 p-4 rounded-lg text-sm bg-red-100 text-red-800';
                messageBox.textContent = 'Errore: Inserisci un numero di alunni valido (minimo 1).';
                messageBox.style.display = 'block';
                return;
            }

            // UI Feedback
            generateBtn.disabled = true;
            downloadIcon.classList.add('hidden');
            loadingIcon.classList.remove('hidden');
            messageBox.style.display = 'none';

            const zip = new JSZip();
            const allExercises = []; // Per le soluzioni del professore

            try {
                // 1. Generazione di Tutte le Verifiche per gli Studenti
                for (let i = 1; i <= studentCount; i++) {
                    const studentExercises = [];
                    for (let j = 0; j < 10; j++) {
                        // Genera 10 esercizi unici per studente
                        const ex = generateExercise(j, i);
                        studentExercises.push(ex);
                        if (i === 1) allExercises.push(ex); // Salva le tracce per il docente
                    }

                    const studentHtml = generateStudentHtml(i, studentExercises);
                    // Uso la versione pulita del PDF
                    const studentPdfBlob = await createPdfBlob(studentHtml);
                    zip.file(`Verifica_Studente_${i}.pdf`, studentPdfBlob);
                }

                // 2. Generazione del PDF delle Soluzioni per il Docente
                const professorHtml = generateProfessorHtml(allExercises);
                const professorPdfBlob = await createPdfBlob(professorHtml);
                zip.file(`SOLUZIONI_DOCENTE.pdf`, professorPdfBlob);

                // 3. Creazione e Download dello ZIP
                const content = await zip.generateAsync({ type: "blob" });
                const fileName = `Verifiche_Rete_Basi_${studentCount}_Alunni.zip`;
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                messageBox.className = 'mt-6 p-4 rounded-lg text-sm bg-green-100 text-green-800';
                messageBox.textContent = `Successo! Generate e scaricate ${studentCount + 1} file nel pacchetto ZIP.`;
                messageBox.style.display = 'block';

            } catch (error) {
                console.error("Errore durante la generazione o il download:", error);
                messageBox.className = 'mt-6 p-4 rounded-lg text-sm bg-red-100 text-red-800';
                messageBox.textContent = 'Errore critico durante la generazione dei PDF. Controlla la console.';
                messageBox.style.display = 'block';
            } finally {
                // Reset UI
                generateBtn.disabled = false;
                downloadIcon.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
            }
        }

        // --- FUNZIONE DI CONVERSIONE HTML A PDF (Gestione Pagine) ---

        async function createPdfBlob(htmlContent) {
            const pdfContainer = document.getElementById('pdfContainer');
            pdfContainer.innerHTML = htmlContent;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const pages = pdfContainer.querySelectorAll('.a4-container');
            const pdfWidth = 210; // A4 in mm
            const pdfHeight = 297; // A4 in mm

            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                if (i > 0) {
                    doc.addPage();
                }

                // Usa html2canvas per renderizzare il div A4 in una tela (canvas)
                const canvas = await html2canvas(page, {
                    scale: 2, // Aumenta la scala per una migliore qualità
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    removeContainer: true
                });

                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                
                // La pagina deve essere sempre A4, l'immagine viene ridimensionata per adattarsi
                doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, null, 'FAST');
            }

            // Resetta il container DOM
            pdfContainer.innerHTML = '';

            return doc.output('blob');
        }

        window.onload = function() {
            console.log("Generatore Verifiche avviato. App ID:", appId);
        };
    </script>
</body>
</html>
